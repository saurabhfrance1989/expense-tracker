<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Buddy - Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script>
        // Redirect to login if not authenticated
        if (!localStorage.getItem('loggedInUser')) {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>
    <div class="navbar">
        <a href="index.html">Dashboard</a>
        <a href="documentation.html">Resources</a>
    </div>

    <div class="page-content-wrapper">
        <div class="container dashboard-container">
            <header class="dashboard-header">
                <div class="header-content">
                    <h1>Budget Buddy</h1>
                    <p>Welcome, <span id="usernameDisplay"></span>!</p>
                </div>
                <button id="logoutBtn" class="btn btn-secondary">Logout</button>
            </header>

            <!-- Summary Section -->
            <section class="summary-section">
                <h2>Overview</h2>
                <div class="summary-cards">
                    <div class="summary-card income-card">
                        <h3>Total Income</h3>
                        <div class="amount" id="totalIncomeDisplay">₹0</div>
                        <input type="number" id="monthlyIncome" placeholder="Set Monthly Income" step="0.01">
                    </div>
                    <div class="summary-card expense-card">
                        <h3>Total Expenses</h3>
                        <div class="amount" id="totalExpensesDisplay">₹0</div>
                    </div>
                    <div class="summary-card balance-card">
                        <h3>Remaining Balance</h3>
                        <div class="amount" id="remainingBalanceDisplay">₹0</div>
                    </div>
                </div>
            </section>

            <!-- Add Expense Form -->
            <section class="add-expense-section">
                <h2>Add New Expense</h2>
                <form id="addExpenseForm" class="expense-form">
                    <div class="form-group">
                        <label for="expenseDescription">Description</label>
                        <input type="text" id="expenseDescription" placeholder="e.g., Coffee" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">Amount</label>
                        <input type="number" id="expenseAmount" placeholder="e.g., 50" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory">
                            <option value="food">Food</option>
                            <option value="transport">Transport</option>
                            <option value="utilities">Utilities</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="health">Health</option>
                            <option value="education">Education</option>
                            <option value="apparel">Apparel</option>
                            <option value="household">Household</option>
                            <option value="personalCare">Personal Care</option>
                            <option value="gifts">Gifts/Donations</option>
                            <option value="debt">Debt Payment</option>
                            <option value="investment">Investment</option>
                            <option value="rentMortgage">Rent/Mortgage</option>
                            <option value="insurance">Insurance</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Date</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Expense</button>
                </form>
            </section>

            <!-- Expenses List Section -->
            <section class="expenses-list-section">
                <h2>Your Expenses</h2>
                <div class="filter-controls">
                    <label for="categoryFilter">Filter by Category:</label>
                    <select id="categoryFilter">
                        <option value="all">All Categories</option>
                        {/* Options will be populated by JS */}
                    </select>
                    <label for="monthFilter">Filter by Month:</label>
                    <input type="month" id="monthFilter">
                </div>
                <div class="table-responsive">
                    <table id="expensesTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expensesTableBody">
                            {/* Expenses will be populated here by JavaScript */}
                        </tbody>
                    </table>
                </div>
                <p id="noExpensesMessage" style="display: none; text-align: center;">No expenses recorded yet.</p>
            </section>
            
            <div class="dashboard-actions">
                <button class="btn" id="downloadCsvBtn">Download Expenses as CSV</button>
                <button class="btn btn-danger" id="resetAllBtn">Reset All User Data</button>
            </div>

        </div>
    </div>

    <script>
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
            document.getElementById('usernameDisplay').textContent = loggedInUser;
        } else {
            window.location.href = 'login.html';
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('loggedInUser');
                window.location.href = 'login.html';
            }
        });

        // --- Data Keys ---
        const getIncomeKey = (user) => `monthlyIncome_${user}`;
        const getExpensesArrayKey = (user) => `expensesArray_${user}`; // Changed from object to array

        // --- Global State ---
        let monthlyIncome = 0;
        let expenses = []; // Array of expense objects: {id, description, amount, category, date}

        // --- DOM Elements ---
        const monthlyIncomeInput = document.getElementById('monthlyIncome');
        const totalIncomeDisplay = document.getElementById('totalIncomeDisplay');
        const totalExpensesDisplay = document.getElementById('totalExpensesDisplay');
        const remainingBalanceDisplay = document.getElementById('remainingBalanceDisplay');
        const addExpenseForm = document.getElementById('addExpenseForm');
        const expensesTableBody = document.getElementById('expensesTableBody');
        const noExpensesMessage = document.getElementById('noExpensesMessage');
        const categoryFilter = document.getElementById('categoryFilter');
        const monthFilter = document.getElementById('monthFilter');
        const expenseCategorySelect = document.getElementById('expenseCategory'); // For populating filter

        // --- Utility Functions ---
        function formatCurrency(amount) {
            return '₹' + amount.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // --- Data Persistence ---
        function loadUserData() {
            if (!loggedInUser) return;
            const storedIncome = localStorage.getItem(getIncomeKey(loggedInUser));
            monthlyIncome = parseFloat(storedIncome) || 0;

            const storedExpenses = localStorage.getItem(getExpensesArrayKey(loggedInUser));
            expenses = storedExpenses ? JSON.parse(storedExpenses) : [];
            
            monthlyIncomeInput.value = monthlyIncome > 0 ? monthlyIncome : '';
        }

        function saveUserData() {
            if (!loggedInUser) return;
            localStorage.setItem(getIncomeKey(loggedInUser), monthlyIncome.toString());
            localStorage.setItem(getExpensesArrayKey(loggedInUser), JSON.stringify(expenses));
        }

        // --- UI Update Functions ---
        function updateSummary() {
            const totalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount), 0);
            const balance = monthlyIncome - totalExpenses;

            totalIncomeDisplay.textContent = formatCurrency(monthlyIncome);
            totalExpensesDisplay.textContent = formatCurrency(totalExpenses);
            remainingBalanceDisplay.textContent = formatCurrency(balance);

            const balanceCard = remainingBalanceDisplay.closest('.summary-card');
            if (balance < 0) {
                balanceCard.classList.add('negative-balance');
                balanceCard.classList.remove('positive-balance');
            } else {
                balanceCard.classList.add('positive-balance');
                balanceCard.classList.remove('negative-balance');
            }
            saveUserData();
        }
        
        function populateCategoryFilter() {
            const uniqueCategories = [...new Set(expenses.map(exp => exp.category))].sort();
            const formCategories = Array.from(expenseCategorySelect.options).map(opt => opt.value);
            const allCategories = [...new Set([...uniqueCategories, ...formCategories])].sort();

            categoryFilter.innerHTML = '<option value="all">All Categories</option>'; // Reset
            allCategories.forEach(category => {
                if(category) { // Ensure category is not empty
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    categoryFilter.appendChild(option);
                }
            });
        }


        function renderExpenses() {
            expensesTableBody.innerHTML = ''; // Clear existing rows
            
            const selectedCategory = categoryFilter.value;
            const selectedMonth = monthFilter.value; // YYYY-MM

            const filteredExpenses = expenses.filter(expense => {
                const categoryMatch = selectedCategory === 'all' || expense.category === selectedCategory;
                let monthMatch = true;
                if (selectedMonth && expense.date) {
                    // expense.date is YYYY-MM-DD, selectedMonth is YYYY-MM
                    monthMatch = expense.date.startsWith(selectedMonth);
                }
                return categoryMatch && monthMatch;
            });


            if (filteredExpenses.length === 0) {
                noExpensesMessage.style.display = 'block';
                expensesTable.style.display = 'none';
            } else {
                noExpensesMessage.style.display = 'none';
                expensesTable.style.display = ''; // Show table
                filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
                
                filteredExpenses.forEach(expense => {
                    const row = expensesTableBody.insertRow();
                    row.setAttribute('data-id', expense.id);
                    row.insertCell().textContent = new Date(expense.date).toLocaleDateString('en-CA'); // YYYY-MM-DD for consistency
                    row.insertCell().textContent = expense.description;
                    row.insertCell().textContent = expense.category.charAt(0).toUpperCase() + expense.category.slice(1);
                    row.insertCell().textContent = formatCurrency(parseFloat(expense.amount));

                    const actionsCell = row.insertCell();
                    const editButton = document.createElement('button');
                    editButton.classList.add('btn', 'btn-sm', 'btn-edit');
                    editButton.textContent = 'Edit';
                    editButton.onclick = () => handleEditExpense(expense.id);
                    actionsCell.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.classList.add('btn', 'btn-sm', 'btn-delete');
                    deleteButton.textContent = 'Delete';
                    deleteButton.onclick = () => handleDeleteExpense(expense.id);
                    actionsCell.appendChild(deleteButton);
                });
            }
            updateSummary();
            populateCategoryFilter(); // Update filter options based on current expenses
        }

        // --- Event Handlers ---
        monthlyIncomeInput.addEventListener('input', function() {
            monthlyIncome = parseFloat(this.value) || 0;
            updateSummary(); // This also saves
        });

        addExpenseForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const date = document.getElementById('expenseDate').value;

            if (!description || isNaN(amount) || amount <= 0 || !category || !date) {
                alert('Please fill all fields correctly.');
                return;
            }
            
            const editingId = addExpenseForm.dataset.editingId;
            if (editingId) { // Editing existing expense
                const expenseIndex = expenses.findIndex(exp => exp.id === editingId);
                if (expenseIndex > -1) {
                    expenses[expenseIndex] = { ...expenses[expenseIndex], description, amount, category, date };
                }
                delete addExpenseForm.dataset.editingId; // Clear editing state
                addExpenseForm.querySelector('button[type="submit"]').textContent = 'Add Expense';
            } else { // Adding new expense
                const newExpense = { id: generateId(), description, amount, category, date };
                expenses.push(newExpense);
            }

            addExpenseForm.reset();
            document.getElementById('expenseDate').valueAsDate = new Date(); // Reset date to today
            renderExpenses(); // This calls updateSummary which saves
        });

        function handleEditExpense(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (expense) {
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseAmount').value = expense.amount;
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseDate').value = expense.date;
                addExpenseForm.dataset.editingId = id; // Mark that we are editing
                addExpenseForm.querySelector('button[type="submit"]').textContent = 'Update Expense';
                document.getElementById('expenseDescription').focus();
            }
        }

        function handleDeleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(expense => expense.id !== id);
                renderExpenses(); // This calls updateSummary which saves
            }
        }
        
        categoryFilter.addEventListener('change', renderExpenses);
        monthFilter.addEventListener('input', renderExpenses);


        document.getElementById('resetAllBtn').addEventListener('click', function() {
            if (confirm(`Are you sure you want to reset all income and expenses for ${loggedInUser}? This action cannot be undone.`)) {
                monthlyIncome = 0;
                expenses = [];
                monthlyIncomeInput.value = '';
                localStorage.removeItem(getIncomeKey(loggedInUser));
                localStorage.removeItem(getExpensesArrayKey(loggedInUser));
                renderExpenses(); // This calls updateSummary which saves the empty state
            }
        });

        document.getElementById('downloadCsvBtn').addEventListener('click', function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Description,Category,Amount\r\n";

            const dataToExport = expenses.slice().sort((a,b) => new Date(a.date) - new Date(b.date)); // Sort by date ascending for export

            dataToExport.forEach(expense => {
                csvContent += `${expense.date},"${expense.description.replace(/"/g, '""')}",${expense.category},${expense.amount}\r\n`;
            });
            
            // Add income as a summary line if needed, or handle separately
            // For now, just expenses.
            // csvContent += `\r\nMonthly Income,,,${monthlyIncome}\r\n`;


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `expenses_${loggedInUser}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- Initialization ---
        function initializeDashboard() {
            if (!loggedInUser) return;
            loadUserData();
            document.getElementById('expenseDate').valueAsDate = new Date(); // Set default date to today
            renderExpenses(); // Initial render
        }

        initializeDashboard();
    </script>
</body>
</html>
